<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MySawit - Modul 4 Pengiriman</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    h1, h2 { color: #2c3e50; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    input[type="number"], input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    button { background-color: #27ae60; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; font-weight: bold; }
    button:hover { background-color: #2ecc71; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background-color: #f2f2f2; }
    .response-box { margin-top: 10px; padding: 10px; background-color: #e8f8f5; border-left: 4px solid #1abc9c; display: none; }
  </style>
</head>
<body>

<div class="container">
  <h1>üöõ Dashboard Pengiriman MySawit</h1>

  <hr>

  <h2>1. Buat Penugasan Supir Baru</h2>
  <div class="form-group">
    <label>ID Mandor (Yang Menugaskan):</label>
    <input type="number" id="mandorId" placeholder="Contoh: 1">
  </div>
  <div class="form-group">
    <label>ID Supir:</label>
    <input type="number" id="supirId" placeholder="Contoh: 5">
  </div>
  <div class="form-group">
    <label>ID Hasil Panen (Pisahkan dengan koma):</label>
    <input type="text" id="hasilPanenIds" placeholder="Contoh: 101, 102, 103">
  </div>
  <button onclick="tugaskanSupir()">Tugaskan Supir</button>
  <div id="postResult" class="response-box"></div>

  <hr style="margin-top: 30px;">

  <h2>2. Riwayat Pengiriman</h2>
  <button onclick="getDaftarPengiriman()" style="background-color: #3498db;">Muat Ulang Data</button>

  <table id="tabelPengiriman">
    <thead>
    <tr>
      <th>ID</th>
      <th>Status</th>
      <th>Total Berat (Kg)</th>
      <th>Status Mandor</th>
      <th>Status Admin</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<script>
  // Fungsi untuk nembak API POST
  async function tugaskanSupir() {
    const mandorId = document.getElementById('mandorId').value;
    const supirId = document.getElementById('supirId').value;
    const panenInput = document.getElementById('hasilPanenIds').value;

    // Mengubah input "1,2,3" menjadi array angka [1, 2, 3]
    const hasilPanenIds = panenInput.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));

    const requestBody = {
      supirId: parseInt(supirId),
      hasilPanenIds: hasilPanenIds
    };

    try {
      const response = await fetch(`/api/pengiriman?mandorId=${mandorId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
      });

      const resultBox = document.getElementById('postResult');
      resultBox.style.display = 'block';

      if (response.ok) {
        const data = await response.json();
        resultBox.innerHTML = `‚úÖ <b>Sukses!</b> Pengiriman ID ${data.id} berhasil dibuat dengan status: ${data.statusPengiriman}`;
        getDaftarPengiriman(); // Otomatis refresh tabel bawah
      } else {
        resultBox.innerHTML = `‚ùå <b>Gagal:</b> Terjadi kesalahan atau muatan melebihi 400 Kg.`;
      }
    } catch (error) {
      alert('Gagal menghubungi server!');
    }
  }

  // Fungsi untuk nembak API GET
  async function getDaftarPengiriman() {
    try {
      const response = await fetch('/api/pengiriman');
      if (response.ok) {
        const data = await response.json();
        const tbody = document.querySelector('#tabelPengiriman tbody');
        tbody.innerHTML = ''; // Kosongkan isi tabel lama

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Belum ada data pengiriman.</td></tr>';
          return;
        }

        data.forEach(item => {
          const row = `<tr>
                        <td>${item.id}</td>
                        <td><b>${item.statusPengiriman}</b></td>
                        <td>${item.totalBeratKg} Kg</td>
                        <td>${item.statusApprovalMandor}</td>
                        <td>${item.statusApprovalAdmin}</td>
                    </tr>`;
          tbody.innerHTML += row;
        });
      }
    } catch (error) {
      console.error("Gagal mengambil data", error);
    }
  }

  // Panggil otomatis saat halaman pertama kali dibuka
  window.onload = getDaftarPengiriman;
</script>

</body>
</html>